<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no"/>
  <title>Chatus | Social Hub</title>

  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">

  <style>
    /* --- CSS VARIABLES & RESET --- */
    :root {
      --primary: #6c5ce7;
      --secondary: #a29bfe;
      --accent: #ff7675;
      --bg-gradient: linear-gradient(135deg, #74ebd5 0%, #ACB6E5 100%);
      --glass-bg: rgba(255, 255, 255, 0.95);
      --shadow: 0 8px 32px 0 rgba(31, 38, 135, 0.15);
      --radius: 16px;
    }

    * { margin: 0; padding: 0; box-sizing: border-box; font-family: 'Poppins', sans-serif; }
    
    body { 
      background: var(--bg-gradient); 
      min-height: 100vh; 
      color: #2d3436; 
      padding-top: 80px; 
      padding-bottom: 20px;
    }

    /* --- HEADER --- */
    header {
      background: rgba(255, 255, 255, 0.85);
      backdrop-filter: blur(10px);
      -webkit-backdrop-filter: blur(10px);
      padding: 10px 20px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: fixed;
      width: 100%;
      top: 0;
      z-index: 100;
      box-shadow: 0 2px 10px rgba(0,0,0,0.05);
    }
    .brand { display: flex; align-items: center; gap: 10px; }
    #profile-icon {
      background: var(--primary); color: white; width: 45px; height: 45px; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-weight: 700;
      border: 2px solid white; box-shadow: 0 2px 5px rgba(0,0,0,0.1);
    }
    .app-name { font-weight: 700; font-size: 1.2rem; color: var(--primary); }
    #switch-btn { cursor: pointer; font-size: 1.5rem; padding: 5px; border-radius: 8px; transition: 0.2s; }
    #switch-btn:hover { background: #eee; }

    #switch-menu {
      display: none; position: absolute; top: 65px; right: 20px; background: white;
      border-radius: 10px; padding: 10px; box-shadow: 0 5px 20px rgba(0,0,0,0.15);
      width: 200px; z-index: 101;
    }
    #switch-menu button {
      width: 100%; padding: 10px; text-align: left; background: none; border: none;
      cursor: pointer; font-weight: 500; border-radius: 5px;
    }
    #switch-menu button:hover { background: #f1f2f6; color: var(--primary); }

    /* --- GREETING --- */
    #greeting-section { 
      text-align: center; padding: 20px; color: #2d3436;
      text-shadow: 0 1px 2px rgba(255,255,255,0.5);
    }
    #greeting { font-weight: 600; font-size: 1.8rem; }

    /* --- MAIN LAYOUT --- */
    .container {
      max-width: 1200px; margin: 0 auto; display: grid;
      grid-template-columns: 1fr 380px; gap: 25px; padding: 0 20px;
    }
    .left-section { display: flex; flex-direction: column; gap: 20px; }
    .right-section {
      background: var(--glass-bg); border-radius: var(--radius); padding: 20px;
      height: fit-content; position: sticky; top: 100px; box-shadow: var(--shadow);
    }

    /* --- POST & UPLOAD UI --- */
    .share-card {
      background: var(--glass-bg); padding: 20px; border-radius: var(--radius);
      box-shadow: var(--shadow); display: flex; flex-direction: column; gap: 15px;
    }
    .share-header { font-weight: 600; color: #636e72; }
    .share-buttons { display: flex; gap: 10px; }
    
    .btn { padding: 10px 20px; border: none; border-radius: 50px; cursor: pointer; font-weight: 600; transition: transform 0.1s; color: white; }
    .btn:active { transform: scale(0.98); }
    .btn-primary { background: var(--primary); }
    .btn-accent { background: var(--accent); }

    /* Public Posts */
    #posts { display: flex; flex-direction: column; gap: 20px; margin-top: 20px;}
    .post {
      background: white; padding: 20px; border-radius: var(--radius);
      box-shadow: var(--shadow); animation: fadeIn 0.5s ease; position: relative; overflow: hidden;
    }
    @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }

    .post-header { display: flex; align-items: center; margin-bottom: 15px; }
    .post-logo {
      background: linear-gradient(45deg, var(--primary), var(--secondary)); color: white;
      width: 40px; height: 40px; border-radius: 50%; display: flex; align-items: center;
      justify-content: center; margin-right: 12px; font-weight: bold;
    }
    .post-username { font-weight: 600; }
    .post-img { width: 100%; border-radius: 12px; margin-bottom: 15px; object-fit: cover; max-height: 400px; }
    .poll-box { background: #f8f9fa; padding: 15px; border-radius: 12px; margin-bottom: 15px; border-left: 4px solid var(--primary); }
    .post-caption { margin-bottom: 15px; line-height: 1.5; color: #444; }
    
    .post-actions { display: flex; justify-content: space-between; border-top: 1px solid #f1f2f6; padding-top: 10px; }
    .action-btn { background: none; border: none; cursor: pointer; color: #636e72; font-size: 0.9rem; font-weight: 500; }
    .comments-section { margin-top: 15px; background: #f9f9f9; padding: 10px; border-radius: 10px; display: none; }
    .comment-input-group { display: flex; gap: 5px; margin-top: 10px; }
    .comment-input-group input { flex: 1; padding: 8px; border: 1px solid #ddd; border-radius: 5px; }
    .btn-sm { padding: 5px 10px; font-size: 0.8rem; border-radius: 6px; border: none; cursor: pointer; background: var(--primary); color: white;}

    /* --- PERSONAL POST STYLES --- */
    .personal-post-container { margin-bottom: 10px; }
    .swipe-hint {
        position: absolute; bottom: 10px; right: 10px; font-size: 0.75rem; 
        color: var(--primary); opacity: 0.8; pointer-events: none; background: rgba(255,255,255,0.8);
        padding: 2px 8px; border-radius: 10px; animation: swipeAnim 2s infinite;
    }
    @keyframes swipeAnim { 0% { transform: translateX(0); } 50% { transform: translateX(5px); } 100% { transform: translateX(0); } }

    #see-more-btn {
        background: none; border: none; color: var(--primary); font-weight: 600; 
        cursor: pointer; align-self: center; display: none; margin: 10px auto;
    }

    /* --- MODALS --- */
    .modal-overlay {
        position: fixed; top: 0; left: 0; width: 100%; height: 100%;
        background: rgba(0,0,0,0.6); z-index: 1000; display: none;
        align-items: center; justify-content: center; backdrop-filter: blur(5px);
    }
    .modal-content {
        background: white; width: 90%; max-width: 500px; padding: 25px;
        border-radius: 20px; position: relative; max-height: 85vh; overflow-y: auto;
        box-shadow: 0 10px 30px rgba(0,0,0,0.3); animation: scaleIn 0.3s ease;
    }
    @keyframes scaleIn { from { transform: scale(0.95); opacity: 0; } to { transform: scale(1); opacity: 1; } }
    
    .modal-header { font-size: 1.2rem; font-weight: 700; margin-bottom: 15px; color: #333; }
    .close-modal { position: absolute; top: 15px; right: 20px; font-size: 1.5rem; cursor: pointer; color: #999; }
    
    /* Upload UI */
    #upload-preview { width: 100%; border-radius: 10px; display: none; margin-bottom: 15px; max-height: 300px; object-fit: cover; }
    .thoughts-input { width: 100%; padding: 15px; border: 1px solid #eee; border-radius: 10px; resize: none; outline: none; margin-bottom: 15px; font-family: inherit; font-size: 0.95rem; }
    .upload-actions { display: flex; justify-content: flex-end; }
    .publish-icon { background: var(--primary); color: white; width: 50px; height: 50px; border-radius: 50%; display: flex; align-items: center; justify-content: center; cursor: pointer; box-shadow: 0 4px 10px rgba(108, 92, 231, 0.4); font-size: 1.2rem; }

    /* Share UI */
    .share-section-title { font-weight: 600; color: #777; margin: 15px 0 5px; font-size: 0.9rem; }
    .share-list { display: flex; flex-direction: column; gap: 8px; }
    .share-item { padding: 10px; background: #f8f9fa; border-radius: 8px; display: flex; align-items: center; cursor: pointer; border: 1px solid transparent; transition: 0.2s; }
    .share-item:hover { background: #f0f0f0; }
    .share-item.selected { border-color: var(--primary); background: #f0f0ff; }
    .share-avatar { width: 35px; height: 35px; background: var(--secondary); color: white; border-radius: 50%; display: flex; align-items: center; justify-content: center; margin-right: 10px; font-size: 0.9rem; font-weight: bold; }

    /* --- SIDEBAR & CHAT --- */
    .sidebar-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 15px; margin-top: 20px; }
    .search-box input { width: 100%; padding: 12px; border-radius: 10px; border: 1px solid #dfe6e9; background: #f1f2f6; margin-bottom: 15px; outline: none; }
    .user-result { display: flex; align-items: center; padding: 10px; background: white; border-radius: 10px; margin-bottom: 10px; box-shadow: 0 2px 5px rgba(0,0,0,0.05); }
    .user-name { font-weight: 500; margin-left: 10px; flex: 1; }
    select#filter-select { padding: 8px 12px; border-radius: 8px; border: 1px solid #dfe6e9; background: white; color: var(--primary); font-weight: 600; cursor: pointer; outline: none; }
    
    #friends-list { max-height: 200px; overflow-y: auto; display: flex; flex-direction: column; gap: 8px; }
    .friend-item { 
      padding: 12px; 
      background: white; 
      border-radius: 8px; 
      cursor: pointer; 
      transition: 0.2s; 
      display: flex; 
      align-items: center; 
      gap: 10px;
    }
    .friend-item:hover { background: #f1f2f6; transform: translateX(5px); }
    .friend-avatar {
      width: 35px; height: 35px; background: var(--primary); color: white; border-radius: 50%;
      display: flex; align-items: center; justify-content: center; font-weight: bold; font-size: 0.9rem;
    }
    .req-tag { font-size: 0.7rem; background: var(--accent); color: white; padding: 2px 6px; border-radius: 4px; margin-left: auto; }

    /* Chat */
    #chat-section { margin-top: 25px; border-top: 1px solid #dfe6e9; padding-top: 15px; display: none; }
    .chat-header { 
      font-weight: 700; 
      color: var(--primary); 
      margin-bottom: 5px; 
      display: flex; 
      justify-content: space-between; 
      align-items: center;
    }
    .gaali-info {
      display: flex;
      flex-direction: column;
      align-items: flex-end;
      font-size: 0.8rem;
    }
    #gaali-points {
      font-weight: 700;
      color: var(--accent);
    }
    #gaali-tag {
      color: #666;
      font-size: 0.75rem;
    }
    #chat-window { height: 300px; overflow-y: auto; background: #f8f9fa; border-radius: 10px; padding: 10px; margin-bottom: 10px; display: flex; flex-direction: column; gap: 8px; }
    .msg { padding: 8px 12px; border-radius: 8px; max-width: 80%; font-size: 0.9rem; line-height: 1.4; word-wrap: break-word;}
    .msg-img { max-width: 100%; border-radius: 8px; margin-bottom: 5px; display: block; }
    .msg-sent { background: var(--primary); color: white; align-self: flex-end; border-bottom-right-radius: 2px; }
    .msg-received { background: #e0e0e0; color: #333; align-self: flex-start; border-bottom-left-radius: 2px; }
    .chat-input-area { display: flex; gap: 8px; }
    #message-input { flex: 1; padding: 10px; border-radius: 20px; border: 1px solid #dfe6e9; outline: none; }
    #send-btn { width: 40px; height: 40px; border-radius: 50%; border: none; background: var(--primary); color: white; cursor: pointer; display: flex; align-items: center; justify-content: center; }

    /* Mobile */
    @media (max-width: 900px) {
      .container { grid-template-columns: 1fr; gap: 30px; padding: 0 15px; }
      .right-section { position: static; order: 2; }
      .left-section { order: 1; }
      .modal-content { width: 95%; margin: 0 auto; }
      #greeting { font-size: 1.4rem; }
      header { padding: 10px 15px; }
    }
  </style>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-app.js";
    import { getDatabase, ref, onValue, push, set, get, update, remove } from "https://www.gstatic.com/firebasejs/9.22.0/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAXmyrXnLAB7eq4rH1cazUciq04WQp2Lew",
      authDomain: "chatus-6fdb7.firebaseapp.com",
      databaseURL: "https://chatus-6fdb7-default-rtdb.firebaseio.com",
      projectId: "chatus-6fdb7",
      storageBucket: "chatus-6fdb7.firebasestorage.app",
      messagingSenderId: "256774540230",
      appId: "1:256774540230:web:43152dbe637b7cee4440c7"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);

    let currentUser = null;
    let currentChatUser = null;
    let gaaliPoints = 0;
    let selectedPostForShare = null;
    let selectedShareFriend = null;

    const badWords = ['gaali1', 'gaali2', 'badword', 'abuse', 'kutte']; 

    function getGaaliTag(points) {
      if (points === 0) return 'Normal Friend';
      if (points <= 5) return 'Jigri Yaar';
      if (points <= 10) return 'Best Buddies';
      if (points <= 20) return 'Life Partners';
      if (points > 20) return 'Inseparable Souls';
      return 'Normal Friend';
    }

    // --- STRICT LOGIN DETECTION ---
    window.addEventListener('load', async () => {
      const userData = localStorage.getItem('currentUser');
      
      if (!userData) { 
        window.location.href = 'login.html'; 
        return; 
      }
      
      currentUser = JSON.parse(userData);
      document.getElementById('greeting').innerText = `Namaste, ${currentUser.name || currentUser.username}`;
      document.getElementById('profile-icon').innerText = (currentUser.username || '').charAt(0).toUpperCase() || '?';

      loadPersonalPosts(); 
      loadPosts();         
      loadFriends('friends');
    });

    // --- UPLOAD & PERSONAL FEED ---
    window.openUploadModal = function(type) {
        if(type === 'image') {
            document.getElementById('upload-modal').style.display = 'flex';
            document.getElementById('upload-preview').src = '';
            document.getElementById('upload-preview').style.display = 'none';
            document.getElementById('thoughts-input').value = '';
            document.getElementById('file-input').value = '';
        } else {
            alert("Poll feature coming soon in popup!");
        }
    }

    window.closeModal = function(id) {
        document.getElementById(id).style.display = 'none';
    }

    window.triggerFileSelect = function() {
        document.getElementById('file-input').click();
    }

    window.handleFileSelect = function(event) {
        const file = event.target.files[0];
        if(file) {
            const reader = new FileReader();
            reader.onload = function(e) {
                const img = document.getElementById('upload-preview');
                img.src = e.target.result;
                img.style.display = 'block';
            }
            reader.readAsDataURL(file);
        }
    }

    window.publishPost = function() {
        const imgSrc = document.getElementById('upload-preview').src;
        const thoughts = document.getElementById('thoughts-input').value;

        if(!imgSrc || imgSrc === window.location.href) {
            alert("Please select a photo first!");
            return;
        }

        push(ref(db, `personal_posts/${currentUser.username}`), {
            image: imgSrc,
            caption: thoughts,
            timestamp: Date.now()
        });

        alert("Published to your private feed!");
        closeModal('upload-modal');
    }

    function loadPersonalPosts() {
        const postsRef = ref(db, `personal_posts/${currentUser.username}`);
        onValue(postsRef, (snap) => {
            const container = document.getElementById('personal-feed');
            container.innerHTML = '';
            const seeMoreBtn = document.getElementById('see-more-btn');
            
            if(!snap.exists()) {
                container.innerHTML = '<p style="text-align:center; color:#999;">No private posts yet.</p>';
                seeMoreBtn.style.display = 'none';
                return;
            }

            const posts = [];
            snap.forEach(c => posts.unshift({ key: c.key, ...c.val() }));

            const latestPost = posts[0];
            const postEl = createPersonalPostElement(latestPost);
            container.appendChild(postEl);

            if(posts.length > 1) {
                seeMoreBtn.style.display = 'block';
                seeMoreBtn.onclick = () => showHistoryModal(posts);
            } else {
                seeMoreBtn.style.display = 'none';
            }
        });
    }

    function createPersonalPostElement(post) {
        const div = document.createElement('div');
        div.className = 'post personal-post-container';
        div.innerHTML = `
            <div class="post-header">
                <div class="post-logo">${(currentUser.username || '').charAt(0).toUpperCase()}</div>
                <div>
                    <div class="post-username">You (Private)</div>
                    <div style="font-size:0.7rem; color:#999;">${new Date(post.timestamp).toLocaleString()}</div>
                </div>
            </div>
            <img src="${post.image}" class="post-img">
            <div class="post-caption"><strong>Thoughts:</strong> ${post.caption || 'No caption'}</div>
            <div class="swipe-hint">Swipe âžœ to Share</div>
        `;

        let touchstartX = 0;
        let touchendX = 0;

        div.addEventListener('touchstart', e => { touchstartX = e.changedTouches[0].screenX; });
        div.addEventListener('touchend', e => {
            touchendX = e.changedTouches[0].screenX;
            if (touchendX > touchstartX + 50) { 
                openShareModal(post); 
            }
        });

        return div;
    }

    function showHistoryModal(allPosts) {
        const modalList = document.getElementById('history-list');
        modalList.innerHTML = '';
        allPosts.forEach(post => {
            const el = createPersonalPostElement(post); 
            modalList.appendChild(el);
        });
        document.getElementById('history-modal').style.display = 'flex';
    }

    function openShareModal(post) {
        selectedPostForShare = post;
        document.getElementById('share-modal').style.display = 'flex';
        loadShareFriendsList();
    }

    function loadShareFriendsList() {
        const listDiv = document.getElementById('share-friends-list');
        listDiv.innerHTML = 'Loading friends...';
        
        get(ref(db, `friends/${currentUser.username}/friends`)).then(snap => {
            listDiv.innerHTML = '';
            if(!snap.exists() || snap.val() === null) { 
                listDiv.innerHTML = '<p style="color:#999;">No friends to share with yet.</p>'; 
                return; 
            }

            const friends = Object.values(snap.val());
            friends.forEach(friend => {
                const item = document.createElement('div');
                item.className = 'share-item';
                item.innerHTML = `
                    <div class="share-avatar">${friend.charAt(0).toUpperCase()}</div>
                    <span>${friend}</span>
                `;
                item.onclick = () => {
                    document.querySelectorAll('.share-item').forEach(i => i.classList.remove('selected'));
                    item.classList.add('selected');
                    selectedShareFriend = friend;
                };
                listDiv.appendChild(item);
            });
        }).catch(err => {
            listDiv.innerHTML = '<p style="color:red;">Error loading friends.</p>';
        });
    }

    window.confirmShare = function() {
        if(!selectedShareFriend || !selectedPostForShare) {
            alert("Please select a friend first!");
            return;
        }

        const chatId = [currentUser.username, selectedShareFriend].sort().join('_');
        
        push(ref(db, `chats/${chatId}`), {
            sender: currentUser.username,
            text: selectedPostForShare.image, 
            type: 'image',
            timestamp: Date.now()
        });

        if(selectedPostForShare.caption) {
            setTimeout(() => {
                push(ref(db, `chats/${chatId}`), {
                    sender: currentUser.username,
                    text: selectedPostForShare.caption,
                    type: 'text',
                    timestamp: Date.now() + 10
                });
            }, 100);
        }

        alert(`Shared with ${selectedShareFriend}!`);
        closeModal('share-modal');
    }

    window.toggleSwitchMenu = function() {
      const menu = document.getElementById('switch-menu');
      menu.style.display = menu.style.display === 'block' ? 'none' : 'block';
    }

    function loadPosts() {
      const postsRef = ref(db, 'posts');
      onValue(postsRef, (snapshot) => {
        const postsDiv = document.getElementById('posts');
        postsDiv.innerHTML = '';
        if(!snapshot.exists()) { 
            postsDiv.innerHTML = '<p style="text-align:center; color:#777;">No public posts yet.</p>'; 
            return; 
        }
        const postsArray = [];
        snapshot.forEach(child => postsArray.unshift({key: child.key, ...child.val()}));
        postsArray.forEach((post) => {
          const postDiv = document.createElement('div');
          postDiv.className = 'post';
          let contentHtml = '';
          if (post.type === 'poll') {
              contentHtml = `<div class="poll-box"><strong>Poll:</strong> ${post.content.option1} <em>vs</em> ${post.content.option2}</div>`;
          } else {
              const imgSrc = post.content || 'https://via.placeholder.com/600x300/6c5ce7/ffffff?text=Image';
              contentHtml = `<img src="${imgSrc}" alt="Post" class="post-img">`;
          }
          postDiv.innerHTML = `
            <div class="post-header">
              <div class="post-logo">${post.user ? post.user.charAt(0).toUpperCase() : '?'}</div>
              <div class="post-username">${post.user || 'Anonymous'}</div>
            </div>
            ${contentHtml}
            <p class="post-caption">${post.caption || ''}</p>
            <div class="post-actions">
              <button class="action-btn" onclick="supportPost('\( {post.key}')">â™¥ Support ( \){post.supports || 0})</button>
              <button class="action-btn" onclick="openComments('${post.key}')">ðŸ’¬ Opinion</button>
              <button class="action-btn" onclick="reportPost('${post.key}')">âš  Report</button>
            </div>
            <div id="comments-${post.key}" class="comments-section"></div>
          `;
          postsDiv.appendChild(postDiv);
          loadComments(post.key);
        });
      });
    }

    window.supportPost = function(postId) { 
      get(ref(db, `posts/${postId}/supports`)).then((snap) => { 
        update(ref(db, `posts/${postId}`), { supports: (snap.val() || 0) + 1 }); 
      }); 
    };

    window.openComments = function(postId) {
      const commentsDiv = document.getElementById(`comments-${postId}`);
      commentsDiv.style.display = commentsDiv.style.display === 'block' ? 'none' : 'block';
      if (!commentsDiv.querySelector('.comment-input-group')) {
        const group = document.createElement('div'); group.className = 'comment-input-group';
        const input = document.createElement('input'); input.placeholder = 'Add your opinion...';
        const btn = document.createElement('button'); btn.innerText = 'Post'; btn.className = 'btn-sm';
        btn.onclick = () => { if(input.value.trim()) addComment(postId, input.value); input.value = ''; };
        group.appendChild(input); group.appendChild(btn); commentsDiv.appendChild(group);
      }
    };

    function loadComments(postId) {
      onValue(ref(db, `posts/${postId}/comments`), (snap) => {
        const commentsDiv = document.getElementById(`comments-${postId}`);
        if (!commentsDiv) return;
        const inputGroup = commentsDiv.querySelector('.comment-input-group');
        commentsDiv.innerHTML = '';
        snap.forEach((child) => {
          const p = document.createElement('p');
          p.textContent = child.val();
          p.style.padding = "5px 0";
          p.style.fontSize = "0.9rem";
          p.style.borderBottom = "1px solid #eee";
          commentsDiv.appendChild(p);
        });
        if(inputGroup) commentsDiv.appendChild(inputGroup);
      });
    }

    function addComment(postId, text) { 
      if (text.trim()) push(ref(db, `posts/\( {postId}/comments`), ` \){currentUser.username}: ${text.trim()}`); 
    }

    // Search
    const searchInput = document.getElementById('search-input');
    searchInput.addEventListener('input', () => { 
      if (searchInput.value.length >= 3) { 
        searchUsers(searchInput.value); 
      } else { 
        document.getElementById('search-results').innerHTML = ''; 
      } 
    });

    function searchUsers(query) {
      onValue(ref(db, 'users'), (snap) => {
        const resultsDiv = document.getElementById('search-results'); 
        resultsDiv.innerHTML = '';
        snap.forEach((child) => {
          const user = child.key;
          if (user.toLowerCase().includes(query.toLowerCase()) && user !== currentUser.username) {
            const userDiv = document.createElement('div'); 
            userDiv.className = 'user-result';
            userDiv.innerHTML = `
              <div class="friend-avatar">${user.charAt(0).toUpperCase()}</div>
              <span class="user-name">${user}</span>
              <button class="btn-sm" onclick="addFriendDirect('${user}')">Direct Add</button>
            `;
            resultsDiv.appendChild(userDiv);
          }
        });
      });
    }

    // DIRECT ADD
    window.addFriendDirect = async function(targetUser) {
        if(targetUser === currentUser.username) {
            alert("You can't add yourself!");
            return;
        }

        const friendsSnap = await get(ref(db, `friends/${currentUser.username}/friends`));
        let alreadyFriend = false;
        if(friendsSnap.exists()) {
            friendsSnap.forEach(child => {
                if(child.val() === targetUser) alreadyFriend = true;
            });
        }

        if(alreadyFriend) {
            alert(`${targetUser} is already your friend!`);
            startChat(targetUser);
            return;
        }

        await push(ref(db, `friends/${currentUser.username}/friends`), targetUser);
        await push(ref(db, `friends/${targetUser}/requests`), currentUser.username);

        alert(`You added ${targetUser} as friend!\nRequest sent. You can chat now.`);
        
        if(document.getElementById('filter-select').value === 'friends') {
            loadFriends('friends');
        }
        document.getElementById('search-results').innerHTML = '';
        document.getElementById('search-input').value = '';
    }

    // ACCEPT REQUEST
    window.acceptRequest = async function(requesterUsername) {
        if(confirm(`Accept friend request from ${requesterUsername}?`)) {
            try {
                await push(ref(db, `friends/${currentUser.username}/friends`), requesterUsername);
                await push(ref(db, `friends/${requesterUsername}/friends`), currentUser.username);

                const requestsRef = ref(db, `friends/${currentUser.username}/requests`);
                const snap = await get(requestsRef);
                if(snap.exists()) {
                    snap.forEach(child => {
                        if(child.val() === requesterUsername) {
                            remove(ref(db, `friends/\( {currentUser.username}/requests/ \){child.key}`));
                        }
                    });
                }

                alert(`You and ${requesterUsername} are now friends! ðŸŽ‰`);
                document.getElementById('filter-select').value = 'friends';
                loadFriends('friends');

            } catch (error) {
                alert("Something went wrong. Try again.");
                console.error(error);
            }
        }
    }

    window.handleFilterChange = function(mode) { 
      if (mode === 'chatus') { 
        startChat('ChatusBot'); 
      } else { 
        loadFriends(mode); 
      } 
    }
    
    function loadFriends(mode) {
      if (!currentUser || !currentUser.username) return;
      const path = 'friends/' + currentUser.username + '/' + mode;
      const friendsRef = ref(db, path);
      onValue(friendsRef, (snap) => {
        const friendsDiv = document.getElementById('friends-list'); 
        friendsDiv.innerHTML = '';
        
        if(!snap.exists() || snap.val() === null) { 
          friendsDiv.innerHTML = `<div style="text-align:center; padding:20px; color:#999;">No ${mode === 'friends' ? 'friends' : 'requests'} yet.</div>`; 
          return; 
        }

        const list = Object.values(snap.val());
        list.forEach((friendName) => {
          const friendDiv = document.createElement('div'); 
          friendDiv.className = 'friend-item';

          const avatar = document.createElement('div');
          avatar.className = 'friend-avatar';
          avatar.textContent = friendName.charAt(0).toUpperCase();

          const nameSpan = document.createElement('span');
          nameSpan.textContent = friendName;

          friendDiv.appendChild(avatar);
          friendDiv.appendChild(nameSpan);

          if(mode === 'requests') { 
              const tag = document.createElement('span');
              tag.className = 'req-tag';
              tag.textContent = 'New';
              friendDiv.appendChild(tag);

              const acceptBtn = document.createElement('button');
              acceptBtn.className = 'btn-sm';
              acceptBtn.style.background = '#00b894';
              acceptBtn.style.marginLeft = '10px';
              acceptBtn.textContent = 'Accept';
              acceptBtn.onclick = (e) => {
                e.stopPropagation();
                acceptRequest(friendName);
              };
              friendDiv.appendChild(acceptBtn);
          } else {
              friendDiv.onclick = () => startChat(friendName);
          }

          friendsDiv.appendChild(friendDiv);
        });
      }, { onlyOnce: false });
    }

    // Chat functions
    window.startChat = function(target) {
      currentChatUser = target;
      document.getElementById('chat-section').style.display = 'block';
      if(window.innerWidth < 900) { 
        document.getElementById('chat-section').scrollIntoView({behavior: "smooth"}); 
      }
      document.getElementById('current-chat-name').innerText = target;
      loadChatMessages(); 
      gaaliPoints = 0; 
      updateGaaliDisplay();
    };

    function loadChatMessages() {
      if (!currentChatUser) return;
      const chatId = [currentUser.username, currentChatUser].sort().join('_');
      onValue(ref(db, `chats/${chatId}`), (snap) => {
        const chatWindow = document.getElementById('chat-window'); 
        chatWindow.innerHTML = '';
        if(!snap.exists()) return;
        snap.forEach((child) => {
          const msg = child.val();
          const msgDiv = document.createElement('div');
          const isMe = msg.sender === currentUser.username;
          msgDiv.className = `msg ${isMe ? 'msg-sent' : 'msg-received'}`;
          
          if(msg.type === 'image') {
              msgDiv.innerHTML = `<img src="${msg.text}" class="msg-img">`;
          } else {
              msgDiv.textContent = msg.text || '';
          }
          
          chatWindow.appendChild(msgDiv);
        });
        chatWindow.scrollTop = chatWindow.scrollHeight;
      });
    }

    window.sendMessage = function() {
      const input = document.getElementById('message-input'); 
      let text = input.value.trim(); 
      if (!text) return;

      badWords.forEach(word => { 
        if (text.toLowerCase().includes(word)) gaaliPoints++; 
      }); 
      updateGaaliDisplay();

      const chatId = [currentUser.username, currentChatUser].sort().join('_');
      push(ref(db, `chats/${chatId}`), { 
        sender: currentUser.username, 
        text: text, 
        type: 'text', 
        timestamp: Date.now() 
      });
      input.value = '';

      if (currentChatUser === 'ChatusBot') { 
        setTimeout(() => { 
          push(ref(db, `chats/${chatId}`), { 
            sender: 'ChatusBot', 
            text: 'Echo: ' + text, 
            type: 'text', 
            timestamp: Date.now() 
          }); 
        }, 500); 
      }
    };

    function updateGaaliDisplay() { 
      document.getElementById('gaali-points').innerText = `${gaaliPoints} Points`;
      document.getElementById('gaali-tag').innerText = getGaaliTag(gaaliPoints);
    }
  </script>
</head>
<body>
  
  <header>
    <div class="brand">
      <div id="profile-icon">?</div>
      <span class="app-name">Chatus</span>
    </div>
    <div id="switch-btn" onclick="toggleSwitchMenu()">â˜°</div>
    <div id="switch-menu">
      <button onclick="window.location.href='room.html'">Public Room</button>
      <button onclick="alert('You are already here')">Sharing Room</button>
      <button onclick="localStorage.removeItem('currentUser'); window.location.href='login.html'">Logout</button>
    </div>
  </header>

  <section id="greeting-section">
    <h1 id="greeting">Welcome</h1>
  </section>

  <div class="container">
    
    <div class="left-section">
      <div class="share-card">
        <div class="share-header">What's on your mind?</div>
        <div class="share-buttons">
          <button class="btn btn-primary" onclick="openUploadModal('image')">ðŸ“· Photo</button>
          <button class="btn btn-accent" onclick="openUploadModal('poll')">ðŸ“Š Poll</button>
        </div>
      </div>
      
      <div id="personal-feed"></div>
      <button id="see-more-btn">See All Posts</button>

      <div id="posts"></div>
    </div>

    <div class="right-section">
      <div class="search-box">
        <input id="search-input" type="text" placeholder="ðŸ” Search people...">
        <div id="search-results"></div>
      </div>

      <div class="sidebar-header">
        <h3>Connections</h3>
        <select id="filter-select" onchange="handleFilterChange(this.value)">
            <option value="friends">Friends</option>
            <option value="requests">Requests</option>
            <option value="chatus">Chatus Bot</option>
        </select>
      </div>

      <div id="friends-list"></div>

      <div id="chat-section">
        <div class="chat-header">
            <span id="current-chat-name">Chat</span>
            <div class="gaali-info">
              <div id="gaali-points">0 Points</div>
              <div id="gaali-tag">Normal Friend</div>
            </div>
        </div>
        <div id="chat-window"></div>
        <div class="chat-input-area">
          <input id="message-input" type="text" placeholder="Type a message...">
          <button id="send-btn" onclick="sendMessage()">âž¤</button>
        </div>
      </div>
    </div>
  </div>

  <!-- All Modals (unchanged) -->
  <div id="upload-modal" class="modal-overlay">
      <div class="modal-content">
          <span class="close-modal" onclick="closeModal('upload-modal')">&times;</span>
          <div class="modal-header">Create Post</div>
          
          <button class="btn btn-primary" style="margin-bottom:15px; width:100%" onclick="triggerFileSelect()">+ Add Photo</button>
          <input type="file" id="file-input" style="display:none" accept="image/*" onchange="handleFileSelect(event)">
          
          <div style="text-align:center">
              <img id="upload-preview" alt="Preview">
          </div>

          <textarea id="thoughts-input" class="thoughts-input" rows="3" placeholder="Your thoughts..."></textarea>
          
          <div class="upload-actions">
              <div onclick="publishPost()" class="publish-icon">âž¤</div>
          </div>
      </div>
  </div>

  <div id="history-modal" class="modal-overlay">
      <div class="modal-content">
          <span class="close-modal" onclick="closeModal('history-modal')">&times;</span>
          <div class="modal-header">Your Timeline</div>
          <div id="history-list" style="display:flex; flex-direction:column; gap:20px"></div>
      </div>
  </div>

  <div id="share-modal" class="modal-overlay">
      <div class="modal-content">
          <span class="close-modal" onclick="closeModal('share-modal')">&times;</span>
          <div class="modal-header">Share Post</div>
          
          <div class="share-section-title">Groups</div>
          <div style="color:#999; font-size:0.8rem; padding:10px;">No groups yet</div>

          <div class="share-section-title">Friends</div>
          <div id="share-friends-list" class="share-list"></div>

          <button class="btn btn-primary" style="width:100%; margin-top:20px" onclick="confirmShare()">Share Now</button>
      </div>
  </div>

</body>
</html>
